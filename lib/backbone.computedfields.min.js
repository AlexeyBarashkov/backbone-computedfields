// Backbone.ComputedFields, v0.0.5
// Copyright (c)2013 alexander.beletsky@gmail.com
// Distributed under MIT license
// http://github.com/alexander.beletsky/backbone.clickdebounce
Backbone.ComputedFields=function(e,t){var n=function(e){this.model=e,this._computedFields=[],this.initialize()};return n.VERSION="0.0.5",t.extend(n.prototype,{initialize:function(){t.bindAll(this),this._lookUpComputedFields(),this._bindModelEvents(),this._wrapJSON()},_lookUpComputedFields:function(){for(var e in this.model.computed){var t=this.model.computed[e];t&&(t.set||t.get)&&this._computedFields.push({name:e,field:t})}},_bindModelEvents:function(){t.each(this._computedFields,function(e){var n=e.name,r=e.field,i=t.bind(function(){var e=this._computeFieldValue(r);this.model.set(n,e,{skipChangeEvent:!0})},this),s=t.bind(function(e,t,i){if(i&&i.skipChangeEvent)return;if(r.set){var s=this._dependentFields(r.depends);t=t||this.model.get(n),r.set.call(this.model,t,s),this.model.set(s,i)}},this);this._thenDependentChanges(r.depends,i),this._thenComputedChanges(n,s),this._isModelInitialized()&&i()},this)},_isModelInitialized:function(){return!t.isEmpty(this.model.attributes)},_thenDependentChanges:function(e,n){t.each(e,function(e){typeof e=="string"&&this.model.on("change:"+e,n),typeof e=="function"&&e.call(this.model,n)},this)},_thenComputedChanges:function(e,t){this.model.on("change:"+e,t)},_wrapJSON:function(){this.model.toJSON=t.wrap(this.model.toJSON,this._toJSON)},_toJSON:function(e){var n=e.call(this.model),r=t.reduce(this._computedFields,function(e,t){return t.field.toJSON===!1&&e.push(t.name),e},[]);return t.omit(n,r)},_computeFieldValue:function(e){if(e&&e.get){var t=this._dependentFields(e.depends);return e.get.call(this.model,t)}},_dependentFields:function(e){return t.reduce(e,function(e,t){return e[t]=this.model.get(t),e},{},this)}}),n}(Backbone,_);